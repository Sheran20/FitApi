name: CI + Deploy Dev (main)

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: dev-main
  cancel-in-progress: true

jobs:
  ci:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: fitapi_test
          POSTGRES_USER: fitapi
          POSTGRES_PASSWORD: fitapi
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U fitapi -d fitapi_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Run tests (Maven)
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/fitapi_test
          SPRING_DATASOURCE_USERNAME: fitapi
          SPRING_DATASOURCE_PASSWORD: fitapi
        run: ./mvnw -q test

  deploy_dev:
    name: Build + Push + Deploy Dev
    runs-on: ubuntu-latest
    needs: [ ci ]
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: ACR login
        run: az acr login --name "${{ vars.ACR_NAME }}"

      - name: Build + push immutable image
        env:
          ACR: ${{ vars.ACR_LOGIN_SERVER }}
          REPO: ${{ vars.IMAGE_REPO }}
          SHA: ${{ github.sha }}
        run: |
          IMAGE="$ACR/$REPO:sha-$SHA"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Record current 100% revision
        env:
          RG: ${{ vars.AZURE_RG_DEV }}
          APP: ${{ vars.AZURE_CA_DEV }}
        run: |
          CUR=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "[?properties.trafficWeight==\`100\`].name | [0]" -o tsv)
          echo "CUR=$CUR" >> $GITHUB_ENV
          echo "Current revision: $CUR"

      - name: Create new revision (keep traffic on current)
        env:
          RG: ${{ vars.AZURE_RG_DEV }}
          APP: ${{ vars.AZURE_CA_DEV }}
          SHA: ${{ github.sha }}
        run: |
          az containerapp update -g "$RG" -n "$APP" \
            --image "$IMAGE" \
            --revision-suffix "sha-${SHA:0:7}"

          NEW_SUFFIX="sha-${SHA:0:7}"

          LATEST=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by(@, &properties.createdTime)[-1].name" -o tsv)

          # Safety fallback: ensure we pick the revision we just deployed
          if [[ -z "$LATEST" || "$LATEST" == "null" || "$LATEST" != *"$NEW_SUFFIX"* ]]; then
            LATEST=$(az containerapp revision list -g "$RG" -n "$APP" \
              --query "reverse(sort_by([?contains(name, '$NEW_SUFFIX')], &properties.createdTime))[0].name" -o tsv)
          fi

          if [[ -z "$LATEST" || "$LATEST" == "null" ]]; then
            echo "ERROR: Could not resolve latest revision name"
            exit 1
          fi

          echo "LATEST=$LATEST" >> $GITHUB_ENV
          echo "Resolved latest revision: $LATEST"

          CUR=$(az containerapp ingress traffic show -g "$RG" -n "$APP" \
            --query "traffic[?weight==\`100\` && latestRevision==\`false\`].revisionName | [0]" -o tsv)

          if [ -z "$CUR" ]; then
            CUR=$(az containerapp revision list -g "$RG" -n "$APP" \
              --query "sort_by([?properties.active==\`true\`], &properties.createdTime)[-1].name" -o tsv)
          fi

          echo "Pinned current revision: $CUR"
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$CUR=100"

      - name: Wait for latest revision provisioning to succeed
        env:
          RG: ${{ vars.AZURE_RG_DEV }}
          APP: ${{ vars.AZURE_CA_DEV }}
        run: |
          for i in {1..10}; do
            LATEST=$(az containerapp revision list -g "$RG" -n "$APP" \
              --query "sort_by([].{n:name,t:properties.createdTime}, &t)[-1].n" -o tsv)
            STATE=$(az containerapp revision show -g "$RG" -n "$APP" --revision "$LATEST" \
              --query "properties.provisioningState" -o tsv)
            echo "Latest: $LATEST | provisioningState: $STATE"
            if [ "$STATE" = "Succeeded" ]; then
              echo "LATEST=$LATEST" >> $GITHUB_ENV
              break
            fi
            sleep 10
          done
          test -n "${LATEST:-}" || (echo "Revision not ready in time" && exit 1)

      - name: Shift 100% traffic to latest revision
        env:
          RG: ${{ vars.AZURE_RG_DEV }}
          APP: ${{ vars.AZURE_CA_DEV }}
          LATEST: ${{ env.LATEST }}
        run: |
          az containerapp ingress traffic set -g "$RG" -n "$APP" \
            --revision-weight "$LATEST=100"
